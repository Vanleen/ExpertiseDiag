---
import "../styles/global.css";
import ConsentBanner from "../components/ConsentBanner.astro";

export interface Props {
  title?: string;
  description?: string;
}
const {
  title = 'Expertise Diag',
  description = 'Diagnostics immobiliers rapides & conformes — Saint-Mandé & Île-de-France.',
} = Astro.props;
---
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{title}</title>
  <meta name="description" content={description} />
  <meta name="theme-color" content="#11114E" />
  <link rel="icon" href="/logo1.png" type="image/png" />

  <!-- Open Graph minimal (non intrusif) -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content={title} />
  <meta property="og:description" content={description} />
  <meta property="og:image" content="/logo1.png" />

  <!-- Preload léger du logo (micro perf) -->
  <link rel="preload" as="image" href="/logo1.svg" imagesrcset="/logo1.svg" />

  <script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "RealEstateInspection",
  "name": "Expertise Diag",
  "url": "https://www.expertisediag.fr",
  "logo": "https://www.expertisediag.fr/logoED.png",
  "image": "https://www.expertisediag.fr/logoED.png",
  "description": "Diagnostics immobiliers certifiés — rapides et conformes en Île-de-France et alentours (89, 45, 28). DPE, Amiante, Gaz, Électricité, Plomb, Loi Carrez, Termites.",
  "telephone": "+33745687654",
  "email": "contact@expertisediag.fr",
  "taxID": "99205834700012",
  "address": {
    "@type": "PostalAddress",
    "streetAddress": "14 avenue du Général de Gaulle",
    "postalCode": "94160",
    "addressLocality": "Saint-Mandé",
    "addressCountry": "FR"
  },
  "areaServed": [
    "Île-de-France",
    "Yonne (89)",
    "Loiret (45)",
    "Eure-et-Loir (28)"
  ],
  "sameAs": []
}
</script>

  <!-- Skip link discret (accessibilité) -->
  <style>
    .skip-link{
      position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden;
    }
    .skip-link:focus{
      position:fixed; left:12px; top:12px; width:auto; height:auto; padding:10px 14px;
      background:#11114E; color:#fff; border-radius:8px; z-index:10000;
      outline:2px solid #fff; outline-offset:2px;
    }
  </style>
</head>

<body class="text-[17px] font-sans antialiased bg-white overflow-x-hidden">
  <!-- Lien d’évitement -->
  <a href="#main" class="skip-link">Aller au contenu</a>

  <!-- Header FIXE -->
  <header id="siteHeader" class="fixed top-0 left-0 right-0 z-40 w-full bg-white/95 backdrop-blur border-b transition-transform duration-150 will-change-transform">
    <div class="w-full px-4 py-3 flex items-center justify-between gap-3">
      <!-- Logo + Nom -->
      <a href="/" class="flex items-center gap-2 shrink-0" aria-label="Accueil Expertise Diag">
        <img src="/logo1.svg" alt="Logo Expertise Diag" class="h-14 w-auto md:h-16" />
        <span class="text-xl md:text-2xl font-bold text-[#11114E] whitespace-nowrap">Expertise Diag</span>
      </a>

      <!-- Zone droite -->
      <div class="flex items-center gap-3 min-w-0">
        <!-- NAV DESKTOP : visible ≥1200px -->
        <nav class="hidden show-desktop items-center gap-6 whitespace-nowrap" aria-label="Navigation principale">
          <a class="hover:underline" href="/diagnostics">Diagnostics</a>
          <a class="hover:underline" href="/zones">Zones</a>
          <a class="hover:underline" href="/blog">Blog</a>
          <a class="hover:underline" href="/a-propos">À propos</a>

          <!-- Bouton téléphone (desktop) -->
          <a href="tel:+33745687654"
             class="inline-flex items-center justify-center rounded-md border border-[#11114E]/30 text-[#11114E] px-3 py-2.5 leading-none">
            <svg class="block h-[20px] w-[20px] relative top-[3px] overflow-visible" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M22 16.92v2a2 2 0 0 1-2.18 2 19.78 19.78 0 0 1-8.63-3.07A19.5 19.5 0 0 1 3.17 9.81 19.78 19.78 0 0 1 .1 1.18 2 2 0 0 1 2.11-.99h2a2 2 0 0 1 2 1.72c.12.9.33 1.77.62 2.61a2 2 0 0 1-.45 2.11L5.4 6.91a16 16 0 0 0 7.69 7.69l1.45-1.88a2 2 0 0 1 2.11-.45c.84.29 1.71.5 2.61.62A2 2 0 0 1 22 16.92Z"
                    stroke="#11114E" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span class="ml-2 whitespace-nowrap">07 45 68 76 54</span>
          </a>

          <!-- Bouton devis (desktop) -->
          <a href="/contact" class="bg-[#11114E] text-white rounded-md hover:opacity-90 transition px-4 py-2">
            Demander un devis
          </a>
        </nav>

        <!-- ACTIONS TABLETTE : visibles 768–1199px -->
        <div class="hidden show-tablet items-center gap-3">
          <a href="tel:+33745687654"
             class="inline-flex items-center justify-center rounded-md border border-[#11114E]/30 text-[#11114E] px-3 py-2.5 leading-none">
            <svg class="block h-[20px] w-[20px] relative top-[3px] overflow-visible" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M22 16.92v2a2 2 0 0 1-2.18 2 19.78 19.78 0 0 1-8.63-3.07A19.5 19.5 0 0 1 3.17 9.81 19.78 19.78 0 0 1 .1 1.18 2 2 0 0 1 2.11-.99h2a2 2 0 0 1 2 1.72c.12.9.33 1.77.62 2.61a2 2 0 0 1-.45 2.11L5.4 6.91a16 16 0 0 0 7.69 7.69l1.45-1.88a2 2 0 0 1 2.11-.45c.84.29 1.71.5 2.61.62A2 2 0 0 1 22 16.92Z"
                    stroke="#11114E" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </a>
          <a href="/contact" class="bg-[#11114E] text-white rounded-md hover:opacity-90 transition px-3 py-2">
            Obtenir un devis
          </a>
        </div>

        <!-- BURGER : visible <1200px -->
        <button id="menuBtn"
          class="show-burger items-center justify-center p-2 rounded focus:outline-none focus-visible:outline"
          aria-controls="drawerOverlay" aria-expanded="false" aria-label="Ouvrir le menu">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M3 6h18M3 12h18M3 18h18" stroke="#11114E" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <!-- OVERLAY + DRAWER MOBILE (plein écran en largeur) -->
  <div id="drawerOverlay" class="fixed inset-0 z-[60]" style="display:none;">
    <!-- Fond grisé (laisse la place à la barre d’actions bas) -->
    <div class="absolute left-0 right-0 top-0 bottom-[calc(var(--actionbar-h,72px))] bg-black/40"></div>

    <!-- Panneau : PLEIN ÉCRAN EN LARGEUR -->
    <aside id="mobileDrawer"
      class="fixed left-0 right-0 top-0 bottom-[calc(var(--actionbar-h,72px))] bg-[#11114E] text-white z-[70]"
      style="transform: translateX(-100%); transition: transform .2s ease;">
      <div class="px-4 py-4 flex items-center justify-between bg-white text-[#11114E] border-b border-black/10">
        <a href="/" class="flex items-center gap-2">
          <img src="/logoED.svg" alt="" class="h-14 w-auto md:h-16" />
          <span class="text-xl md:text-2xl font-bold whitespace-nowrap">Expertise Diag</span>
        </a>
        <button id="closeDrawer" class="p-2 rounded-md hover:bg-black/5" aria-label="Fermer le menu">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M6 6l12 12M18 6l-12 12" stroke="#11114E" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <nav class="px-4 py-2 space-y-1 text-white" aria-label="Menu mobile">
        <a class="block py-3 border-b border-white/15" href="/a-propos">À propos de nous</a>
        <a class="block py-3 border-b border-white/15" href="/diagnostics">Diagnostics immobiliers</a>
        <a class="block py-3 border-b border-white/15" href="/zones">Zones</a>
        <a class="block py-3 border-b border-white/15" href="/blog">Blog</a>
        <a class="block py-3" href="/contact">Contact</a>

        <div class="pt-4 text-white/80 text-sm">Espace client (bientôt)</div>

        <div class="mt-4 space-y-3">
          <a href="tel:+33745687654" class="block text-center border rounded-md py-3 border-white/60 text-white">07 45 68 76 54</a>
          <a href="/contact" class="block text-center rounded-md py-3 bg-white text-[#11114E] font-medium">Demander un devis</a>
        </div>
      </nav>
    </aside>
  </div>

  <!-- Contenu -->
  <main id="main">
    <slot />
  </main>

  <!-- Barre d’actions mobile : < 768px -->
  <div class="md:hidden fixed inset-x-0 bottom-0 z-50 bg-[#11114E]">
    <div class="actionbar-safe px-3 pt-3 grid grid-cols-2 gap-3">
      <!-- TÉLÉPHONE : shield+cookie AVANT l’icône téléphone (cliquable pour ouvrir le modal) -->
      <a href="tel:+33745687654"
         class="rounded-md bg-white text-[#11114E] py-3 text-center font-medium shadow-sm
                inline-flex items-center justify-center gap-2">
        <!-- Stack shield + cookie — ACTIVÉ pour ouvrir le modal -->
        <span class="btn-cookie-stack"
              role="button" tabindex="0"
              aria-label="Paramétrer les cookies"
              title="Paramétrer les cookies">
          <img src="/img/ui/shield.svg" alt="" class="btn-cookie-shield" />
          <img src="/img/ui/cookie.svg" alt="" class="btn-cookie-chip" />
        </span>

        <!-- Icône téléphone bien alignée -->
        <svg class="h-[20px] w-[20px]" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M22 16.92v2a2 2 0 0 1-2.18 2 19.78 19.78 0 0 1-8.63-3.07A19.5 19.5 0 0 1 3.17 9.81 19.78 19.78 0 0 1 .1 1.18 2 2 0 0 1 2.11-.99h2a2 2 0 0 1 2 1.72c.12.9.33 1.77.62 2.61a2 2 0 0 1-.45 2.11L5.4 6.91a16 16 0 0 0 7.69 7.69l1.45-1.88a2 2 0 0 1 2.11-.45c.84.29 1.71.5 2.61.62A2 2 0 0 1 22 16.92Z"
                stroke="#11114E" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span class="whitespace-nowrap">07 45 68 76 54</span>
      </a>

      <a href="/contact"
         class="rounded-md bg-white/0 text-white border border-white py-3 text-center font-medium shadow-sm">
         Obtenir un devis
      </a>
    </div>
  </div>

  <!-- Footer FULL WIDTH -->
  <footer class="mt-20 w-full bg-[#11114E] text-white">
    <!-- Padding bas spécial mobile pour ne pas être caché par la barre d’actions -->
    <div class="w-full px-6 pt-10 pb-[calc(var(--actionbar-h,72px)+24px)] md:pb-6">
      <div class="max-w-6xl mx-auto grid md:grid-cols-2 gap-8">
        <!-- Colonne gauche : identité + coordonnées -->
        <div class="space-y-3">
          <div class="flex items-center gap-3">
            <!-- Pastille logo premium -->
            <span class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-white border border-[#11114E]/20 shadow-black/20">
              <img src="/logo1.svg" alt="Logo Expertise Diag" class="w-12 h-15" />
            </span>
            <p class="text-lg font-semibold">Expertise Diag</p>
          </div>

          <p class="text-white/80">
            14 avenue du Général de Gaulle, 94160 Saint-Mandé
          </p>
          <p class="text-white/80">
            Interventions : Île-de-France et alentours (89, 45, 28)
          </p>
          <p class="text-white/80">
            Tél. <a class="footer-link" href="tel:+33745687654">07&nbsp;45&nbsp;68&nbsp;76&nbsp;54</a>
          </p>
          <p class="text-white/80">
            SIRET : 992&nbsp;058&nbsp;347&nbsp;00012
          </p>
        </div>

        <!-- Colonne droite : liens -->
        <div class="space-y-2 md:text-right">
          <ul class="space-y-2">
            <li><a class="footer-link" href="/mentions-legales">Mentions légales</a></li>
            <li><a class="footer-link" href="/confidentialite">Confidentialité &amp; Cookies</a></li>
            <li><a class="footer-link" href="/zones">Zones d’intervention</a></li>
            <li><a class="footer-link" href="/contact">Contact</a></li>
          </ul>
        </div>
      </div>

      <!-- Bas de footer : copyright centré -->
      <div class="mt-8 pt-6 border-t border-white/15 text-center text-white/80 text-sm">
        © {new Date().getFullYear()} — Expertise Diag — Tous droits réservés.
      </div>
    </div>
  </footer>

  <!-- Bouton back-to-top -->
  <button id="backToTop"
    class="fixed bottom-24 right-4 md:bottom-6 md:right-6 z-40 opacity-0 pointer-events-none transition
           bg-[#FF7B00] text-white rounded-full shadow-lg w-11 h-11 flex items-center justify-center"
    aria-label="Revenir en haut">
    <svg viewBox="0 0 24 24" width="22" height="22" fill="none" aria-hidden="true">
      <path d="M12 19V5M12 5l-6 6M12 5l6 6"
            stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>

  <!-- SCRIPT : header, burger, back-to-top, main offset, cookies triggers -->
  <script is:inline>
    document.addEventListener('DOMContentLoaded', () => {
      const header     = document.getElementById('siteHeader');
      const main       = document.getElementById('main');
      const backToTop  = document.getElementById('backToTop');
      const overlay    = document.getElementById('drawerOverlay');
      const drawer     = document.getElementById('mobileDrawer');
      const menuBtn    = document.getElementById('menuBtn');
      const closeBtn   = document.getElementById('closeDrawer');

      // 1) Caler le contenu sous le header (header fixe)
      function syncMainOffset() {
        const h = header?.offsetHeight || 0;
        if (main) main.style.paddingTop = h + 'px';
      }
      syncMainOffset();
      window.addEventListener('resize', syncMainOffset);

      // 2) Burger open/close
      function openDrawer() {
        if (!overlay || !drawer) return;
        overlay.style.display = 'block';
        requestAnimationFrame(() => { drawer.style.transform = 'translateX(0)'; });
        document.body.style.overflow = 'hidden';
        menuBtn?.setAttribute('aria-expanded', 'true');
      }
      function closeDrawer() {
        if (!overlay || !drawer) return;
        drawer.style.transform = 'translateX(-100%)';
        setTimeout(() => { overlay.style.display = 'none'; }, 200);
        document.body.style.overflow = '';
        menuBtn?.setAttribute('aria-expanded', 'false');
      }
      menuBtn?.addEventListener('click', () => {
        const visible = overlay && overlay.style.display !== 'none';
        visible ? closeDrawer() : openDrawer();
      });
      closeBtn?.addEventListener('click', closeDrawer);
      overlay?.addEventListener('click', (e) => { if (e.target === overlay) closeDrawer(); });
      window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeDrawer(); });

      // 3) Header : flash court au départ du scroll bas, puis visible en continu
      let lastY = window.scrollY;
      let canFlash = true;
      let idleTimer;
      const FLASH_MS = 80;
      const IDLE_MS  = 700;
      header.style.transform = 'translateY(0)';

      function armIdle() {
        clearTimeout(idleTimer);
        idleTimer = setTimeout(() => { canFlash = true; }, IDLE_MS);
      }

      window.addEventListener('scroll', () => {
        const y = window.scrollY;
        const goingDown = y > lastY;

        // Back-to-top
        if (y > 400) backToTop?.classList.remove('opacity-0', 'pointer-events-none');
        else backToTop?.classList.add('opacity-0', 'pointer-events-none');

        if (goingDown) {
          if (canFlash) {
            header.style.transform = 'translateY(-100%)';
            setTimeout(() => { header.style.transform = 'translateY(0)'; }, FLASH_MS);
            canFlash = false;
          } else {
            header.style.transform = 'translateY(0)';
          }
        } else {
          header.style.transform = 'translateY(0)';
        }

        armIdle();
        lastY = y;
      }, { passive: true });

      // 4) Back-to-top
      backToTop?.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });

      // 5) Triggers cookies
      // Badge flottant (desktop/tablette)
      const fab = document.getElementById('cookieFab');
      fab?.addEventListener('click', (e) => {
        e.preventDefault();
        window.dispatchEvent(new CustomEvent('open-consent'));
      });

      // Badge intégré dans le bouton téléphone (mobile)
      const mobileCookie = document.querySelector('.btn-cookie-stack');
      function openConsentFromMobile(e) {
        e.preventDefault();
        e.stopPropagation(); // évite d’appeler le tel:
        window.dispatchEvent(new CustomEvent('open-consent'));
      }
      mobileCookie?.addEventListener('click', openConsentFromMobile);
      mobileCookie?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') openConsentFromMobile(e);
      });
    });
  </script>

  <ConsentBanner />

  <!-- Badge cookies flottant (≥768px) -->
  <button id="cookieFab"
          class="cookie-fab"
          type="button"
          aria-label="Paramétrer les cookies"
          title="Paramétrer les cookies">
    <span class="cookie-stack">
      <img src="/img/ui/shield.svg" alt="" class="fab-shield" />
      <img src="/img/ui/cookie.svg" alt="" class="fab-cookie" />
    </span>
  </button>
</body>
</html>
