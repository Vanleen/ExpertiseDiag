---
import { getCollection, type CollectionEntry } from "astro:content";
import Layout from "../../../layouts/Base.astro";

type Article = CollectionEntry<"articles">;

export async function getStaticPaths() {
  const entries = await getCollection("articles", (e) => !e.data.draft);
  const allTags = new Set<string>();
  for (const e of entries) {
    (e.data.tags || []).forEach((t: string) => allTags.add(t));
  }
  return Array.from(allTags).map((tag) => ({
    params: { tag },
    props: {
      tag,
      articles: entries.filter((e) => (e.data.tags || []).includes(tag)),
    },
  }));
}

const { tag, articles } = Astro.props as { tag: string; articles: Article[] };

const pageTitle = `Articles “${tag}” — Expertise Diag`;
const description = `Tous nos articles associés au tag “${tag}”.`;
---

<Layout title={pageTitle} description={description}>
  <section class="bg-white">
    <div class="px-6 py-14 max-w-6xl mx-auto">
      <nav aria-label="Fil d’Ariane" class="breadcrumbs text-sm text-[#11114E] pb-3 sm:pb-2">
        <a href="/" class="underline underline-offset-4 hover:no-underline">Accueil</a>
        <span class="mx-2" aria-hidden="true">›</span>
        <a href="/articles" class="underline underline-offset-4 hover:no-underline">Articles</a>
        <span class="mx-2" aria-hidden="true">›</span>
        <span class="opacity-80">Tag : {tag}</span>
      </nav>

      <h1 class="text-2xl md:text-3xl font-bold text-[#11114E]">Tag : {tag}</h1>

      {articles.length === 0 ? (
        <p class="mt-4 text-gray-700">Aucun article pour ce tag pour le moment.</p>
      ) : (
        <ul class="mt-6 space-y-4">
          {articles.map((a) => (
            <li class="rounded-xl border border-[#11114E]/10 p-4 bg-[#F6F7FB]">
              <a href={`/articles/${a.slug}`} class="text-[#11114E] font-semibold underline hover:no-underline">
                {a.data.title}
              </a>
              {a.data.description && <p class="mt-1 text-gray-700">{a.data.description}</p>}
              <p class="mt-1 text-xs text-[#11114E]/70">
                Publié le {new Date(a.data.date).toLocaleDateString("fr-FR")}
              </p>
            </li>
          ))}
        </ul>
      )}
    </div>
  </section>
</Layout>
